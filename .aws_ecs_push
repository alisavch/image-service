#!/bin/bash
pip install --user awscli
export PATH=$PATH:$HOME/.local/bin

add-apt-repository ppa:eugenesan/ppa
apt-get update
apt-get install jq -y

curl https://raw.githubusercontent.com/silinternational/ecs-deploy/master/ecs-deploy | \
  sudo tee -a /usr/bin/ecs-deploy
sudo chmod +x /usr/bin/ecs-deploy

eval $(aws ecr get-login --no-include-email --region $AWS_REGION)

# docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD

aws ecr create-repository --repository-name api
aws ecr create-repository --repository-name converter

docker build -t api -f Dockerfile .
docker build -t converter -f Dockerfile-consumer .

docker tag backend:latest $IMAGE_REPO_URL/api:latest
docker tag consumer:latest $IMAGE_REPO_URL/converter:latest

docker push $IMAGE_REPO_URL/api
docker push $IMAGE_REPO_URL/converter

# ecs-deploy -c $CLUSTER_NAME -n $SERVICE_NAME -i $IMAGE_REPO_URL:latest
